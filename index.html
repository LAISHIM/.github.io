<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å›¾åƒå¤„ç†åº”ç”¨</title>
    <link rel="stylesheet" href="static/style.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet"
    />
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div class="header-top">
                <h1>ğŸ¨ æ™ºèƒ½å›¾åƒå¤„ç†</h1>
                <div class="user-info">
                    <span id="userEmailDisplay">æ¬¢è¿, ç”¨æˆ·</span>
                    <a href="#" id="logoutButton" class="logout-button">ç™»å‡º</a>
                </div>
            </div>
            <p>ä¸Šä¼ æ‚¨çš„å›¾ç‰‡ï¼Œå³åˆ»ä½“éªŒç°åº¦è½¬æ¢</p>
        </header>

        <section class="upload-section card">
            <h2>ä¸Šä¼ å›¾ç‰‡</h2>
            <form id="uploadForm" enctype="multipart/form-data" class="upload-form">
                <label for="imageInput" class="custom-file-upload">
                    <span id="fileNameDisplay">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶...</span>
                    <input
                        type="file"
                        name="file"
                        id="imageInput"
                        accept="image/*"
                        required
                    />
                </label>
                <button type="submit" class="submit-button">ä¸Šä¼ å¹¶å¤„ç†</button>
            </form>
            <div id="loadingIndicator" class="loading-indicator">
                <div class="spinner"></div>
                <p>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
            <p id="errorMessage" class="error-message"></p>
        </section>

        <section class="video-section card">
            <h2>å®æ—¶æ‘„åƒå¤´è§†é¢‘</h2>
            <div class="video-wrapper">
                <img id="videoFeed" src="" alt="Camera Feed"
                    onerror="this.onerror=null;this.src='static/video_placeholder.png';" />
            </div>
            <p>æ­¤è§†é¢‘æµæ˜¾ç¤ºå®æ—¶æ‘„åƒå¤´ç”»é¢åŠäººè„¸æ£€æµ‹ã€‚</p>
        </section>

        <section class="results-section" id="resultsSection"></section>

        <footer class="app-footer">
            <p>&copy; 2025 æ™ºèƒ½å›¾åƒå¤„ç†åº”ç”¨. ç‰ˆæƒæ‰€æœ‰.</p>
        </footer>
    </div>

    <script>
        // å®šä¹‰æ‚¨çš„åç«¯ API åŸºç¡€ URL
        // è¯·åŠ¡å¿…å°†æ­¤å¤„çš„ URL æ›¿æ¢ä¸ºæ‚¨çš„ Replit åç«¯å®é™…è¿è¡Œçš„ URL
        const BACKEND_API_BASE_URL = "https://3571b520-68af-404d-828d-860db9009f16-00-3w177559c5lwh.sisko.replit.dev";

        const uploadForm = document.getElementById("uploadForm");
        const imageInput = document.getElementById("imageInput");
        const fileNameDisplay = document.getElementById("fileNameDisplay");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const errorMessage = document.getElementById("errorMessage");
        const resultsSection = document.getElementById("resultsSection");
        const videoFeedImg = document.getElementById("videoFeed"); // è·å–è§†é¢‘æµå›¾ç‰‡å…ƒç´ 
        const userEmailDisplay = document.getElementById("userEmailDisplay"); // è·å–ç”¨æˆ·é‚®ç®±æ˜¾ç¤ºå…ƒç´ 
        const logoutButton = document.getElementById("logoutButton"); // è·å–ç™»å‡ºæŒ‰é’®

        // --- 1. è®¤è¯æ£€æŸ¥å’Œé‡å®šå‘ ---
        async function checkAuthAndRedirect() {
            try {
                // å‘åç«¯å‘èµ·ä¸€ä¸ªæ£€æŸ¥è®¤è¯çš„è¯·æ±‚
                // åç«¯ä¼šæ ¹æ®è¯·æ±‚ä¸­çš„ cookie æ£€æŸ¥ JWT
                const response = await fetch(`${BACKEND_API_BASE_URL}/check_auth`);

                if (response.status === 401) {
                    // å¦‚æœåç«¯è¿”å› 401 Unauthorizedï¼Œè¡¨ç¤º JWT æ— æ•ˆæˆ–ä¸å­˜åœ¨
                    // é‡å®šå‘åˆ°ç™»å½•é¡µï¼Œå¹¶å¸¦ä¸Šå½“å‰é¡µé¢ URL ä½œä¸ºé‡å®šå‘å‚æ•°
                    window.location.href = `login.html?redirect_to=${encodeURIComponent(
                        window.location.pathname + window.location.search
                    )}`;
                } else if (response.ok) {
                    // å¦‚æœè®¤è¯æˆåŠŸ (200 OK)ï¼Œè·å–å¹¶æ˜¾ç¤ºç”¨æˆ·é‚®ç®±
                    const data = await response.json();
                    if (data && data.user_email) {
                        userEmailDisplay.textContent = `æ¬¢è¿, ${data.user_email}`;
                    }
                }
                // å¦‚æœå“åº”æ˜¯ 200 OKï¼Œåˆ™è¯´æ˜è®¤è¯æˆåŠŸï¼Œç»§ç»­åŠ è½½é¡µé¢
            } catch (error) {
                console.error("è®¤è¯æ£€æŸ¥å¤±è´¥:", error);
                // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–é—®é¢˜ï¼Œå¯ä»¥é€‰æ‹©é‡å®šå‘æˆ–æ˜¾ç¤ºé”™è¯¯
                // ä¸ºäº†ä¿è¯å®‰å…¨ï¼Œç½‘ç»œé”™è¯¯ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µ
                window.location.href = `login.html?redirect_to=${encodeURIComponent(
                    window.location.pathname + window.location.search
                )}`;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆæ—¶ç«‹åˆ»æ‰§è¡Œè®¤è¯æ£€æŸ¥
        window.onload = checkAuthAndRedirect;

        // --- 2. ç™»å‡ºåŠŸèƒ½ ---
        logoutButton.addEventListener("click", async (event) => {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„é“¾æ¥è·³è½¬è¡Œä¸º
            try {
                const response = await fetch(`${BACKEND_API_BASE_URL}/logout`, {
                    method: "GET", // å‡è®¾ç™»å‡ºæ˜¯ GET è¯·æ±‚
                });
                if (response.ok) {
                    // ç™»å‡ºæˆåŠŸï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = `${window.location.origin}/login.html`;
                } else {
                    const errorData = await response.json();
                    alert(`ç™»å‡ºå¤±è´¥: ${errorData.detail || "æœªçŸ¥é”™è¯¯"}`);
                }
            } catch (error) {
                console.error("ç™»å‡ºæ—¶å‡ºé”™:", error);
                alert("ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨æ— å“åº”ï¼Œç™»å‡ºå¤±è´¥ã€‚");
            }
        });


        // --- 3. è§†é¢‘æµæ˜¾ç¤º (ä¿®æ­£) ---
        // åŠ¨æ€è®¾ç½®è§†é¢‘æµçš„ srcï¼Œç¡®ä¿ä½¿ç”¨å®Œæ•´çš„åç«¯ URL
        videoFeedImg.src = `${BACKEND_API_BASE_URL}/video_feed`;
        // å¦‚æœè§†é¢‘åŠ è½½å¤±è´¥ï¼ˆä¾‹å¦‚åç«¯æœªå¯åŠ¨æˆ–ç½‘ç»œé—®é¢˜ï¼‰ï¼Œä¼šæ˜¾ç¤ºæ›¿ä»£å›¾ç‰‡

        // --- 4. å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ---
        imageInput.addEventListener("change", () => {
            if (imageInput.files.length > 0) {
                fileNameDisplay.textContent = imageInput.files[0].name;
            } else {
                fileNameDisplay.textContent = "é€‰æ‹©å›¾ç‰‡æ–‡ä»¶...";
            }
        });

        uploadForm.addEventListener("submit", async (event) => {
            event.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º

            errorMessage.textContent = ""; // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            resultsSection.innerHTML = ""; // æ¸…é™¤ä¹‹å‰çš„å›¾ç‰‡ç»“æœ
            resultsSection.style.display = "none"; // éšè—ç»“æœåŒºåŸŸ
            loadingIndicator.style.display = "flex"; // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨

            const formData = new FormData();
            const file = imageInput.files[0];
            if (!file) {
                errorMessage.textContent = "è¯·é€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼";
                loadingIndicator.style.display = "none";
                return;
            }
            formData.append("file", file);

            try {
                // ä½¿ç”¨å®Œæ•´çš„åç«¯ URL
                const response = await fetch(`${BACKEND_API_BASE_URL}/upload_image`, {
                    method: "POST",
                    body: formData,
                });

                if (response.status === 401) {
                    // å¦‚æœåœ¨ä¸Šä¼ è¿‡ç¨‹ä¸­åç«¯è¿”å› 401 Unauthorized
                    // æœªè®¤è¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = `login.html?redirect_to=${encodeURIComponent(
                        window.location.pathname + window.location.search
                    )}`;
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "å›¾ç‰‡å¤„ç†å¤±è´¥ã€‚");
                }

                const data = await response.json();

                // åˆ›å»ºåŸå§‹å›¾ç‰‡å¡ç‰‡
                const originalImageCard = document.createElement("div");
                originalImageCard.className = "image-card";
                originalImageCard.innerHTML = `
                    <h3>åŸå§‹å›¾ç‰‡</h3>
                    <div class="image-wrapper">
                        <img src="${data.original_image_url.startsWith('http') ? data.original_image_url : `${BACKEND_API_BASE_URL}${data.original_image_url}`
                            }" alt="Original Image" onload="this.style.opacity=1;">
                    </div>
                    <p>æ–‡ä»¶å¤§å°: ${formatBytes(file.size)}</p>
                `;

                const processedImageCard = document.createElement("div");
                processedImageCard.className = "image-card";
                processedImageCard.innerHTML = `
                    <h3>ç°åº¦å¤„ç†å›¾ç‰‡</h3>
                    <div class="image-wrapper">
                        <img src="${data.processed_image_url.startsWith('http') ? data.processed_image_url : `${BACKEND_API_BASE_URL}${data.processed_image_url}`
                            }" alt="Grayscale Image" onload="this.style.opacity=1;">
                    </div>
                    <p>å¤„ç†å®Œæˆ</p>
                `;

                // å°†å›¾ç‰‡å¡ç‰‡æ·»åŠ åˆ°ç»“æœåŒºåŸŸ
                resultsSection.appendChild(originalImageCard);
                resultsSection.appendChild(processedImageCard);
                resultsSection.style.display = "flex"; // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            } catch (error) {
                console.error("ä¸Šä¼ æˆ–å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™:", error);
                errorMessage.textContent = "å›¾ç‰‡å¤„ç†å¤±è´¥: " + error.message;
            } finally {
                loadingIndicator.style.display = "none"; // éšè—åŠ è½½æŒ‡ç¤ºå™¨
            }
        });

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return "0 Bytes";
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (
                parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + " " + sizes[i]
            );
        }
    </script>
</body>
</html>
